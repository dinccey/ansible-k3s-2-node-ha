---
- name: Add Kite Helm repo
  kubernetes.core.helm_repository:
    name: kite
    repo_url: "{{ kite_helm_repo }}"
  run_once: true
  delegate_to: "{{ groups['k3s-nodes'][0] }}"

- name: Render kite values file
  template:
    src: kite-values.yaml.j2
    dest: /tmp/kite-values.yaml
    mode: '0644'
  become: true
  run_once: true
  delegate_to: "{{ groups['k3s-nodes'][0] }}"

- name: Render kite PVC manifest
  template:
    src: kite-pvc.yaml.j2
    dest: /tmp/kite-pvc.yaml
    mode: '0644'
  become: true
  run_once: true
  delegate_to: "{{ groups['k3s-nodes'][0] }}"

- name: Ensure Kite namespace exists
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: "{{ kite_namespace }}"
    kubeconfig: "{{ kubeconfig_path }}"
  become: true
  run_once: true
  delegate_to: "{{ groups['k3s-nodes'][0] }}"

- name: Apply kite PVC
  kubernetes.core.k8s:
    src: /tmp/kite-pvc.yaml
    kubeconfig: "{{ kubeconfig_path }}"
    state: present
  become: true
  run_once: true
  delegate_to: "{{ groups['k3s-nodes'][0] }}"

- name: Install or upgrade Kite via Helm
  kubernetes.core.helm:
    name: "{{ kite_release_name }}"
    chart_ref: "{{ kite_chart }}"
    release_namespace: "{{ kite_namespace }}"
    values_files:
      - /tmp/kite-values.yaml
    wait: true
    timeout: 900s
    atomic: true
    kubeconfig: "{{ kubeconfig_path }}"
  become: true
  run_once: true
  delegate_to: "{{ groups['k3s-nodes'][0] }}"

- name: Wait for kite deployment rollout
  command: kubectl -n {{ kite_namespace }} rollout status deployment/{{ kite_release_name }} --timeout=300s
  register: kite_rollout
  retries: 6
  delay: 10
  until: kite_rollout.rc == 0
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"
  become: true
  run_once: true
  delegate_to: "{{ groups['k3s-nodes'][0] }}"

- name: Patch Kite Deployment to use PVC and add anti-affinity
  kubernetes.core.k8s_json_patch:
    api_version: apps/v1
    kind: Deployment
    name: "{{ kite_release_name }}"
    namespace: "{{ kite_namespace }}"
    patch:
      - op: remove
        path: /spec/template/spec/volumes/0/emptyDir
      - op: add
        path: /spec/template/spec/volumes/0/persistentVolumeClaim
        value:
          claimName: "{{ kite_release_name }}-data"
      - op: add
        path: /spec/template/spec/affinity
        value:
          podAntiAffinity:
            preferredDuringSchedulingIgnoredDuringExecution:
              - weight: 100
                podAffinityTerm:
                  labelSelector:
                    matchExpressions:
                      - key: app.kubernetes.io/name
                        operator: In
                        values:
                          - kite
                  topologyKey: kubernetes.io/hostname
    kubeconfig: "{{ kubeconfig_path }}"
  become: true
  run_once: true
  delegate_to: "{{ groups['k3s-nodes'][0] }}"

- name: Wait for kite deployment rollout after patch
  command: kubectl -n {{ kite_namespace }} rollout status deployment/{{ kite_release_name }} --timeout=300s
  register: kite_rollout_patch
  retries: 6
  delay: 10
  until: kite_rollout_patch.rc == 0
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"
  become: true
  run_once: true
  delegate_to: "{{ groups['k3s-nodes'][0] }}"

- name: Apply PodDisruptionBudget for Kite
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: policy/v1
      kind: PodDisruptionBudget
      metadata:
        name: kite-pdb
        namespace: "{{ kite_namespace }}"
      spec:
        minAvailable: 1
        selector:
          matchLabels:
            app.kubernetes.io/name: kite
    kubeconfig: "{{ kubeconfig_path }}"
  become: true
  run_once: true
  delegate_to: "{{ groups['k3s-nodes'][0] }}"

- name: Verify Kite PVC is bound
  kubernetes.core.k8s_info:
    api_version: v1
    kind: PersistentVolumeClaim
    name: "{{ kite_release_name }}-data"
    namespace: "{{ kite_namespace }}"
    kubeconfig: "{{ kubeconfig_path }}"
  register: pvc_status
  become: true
  run_once: true
  delegate_to: "{{ groups['k3s-nodes'][0] }}"

- name: Fail if PVC not bound
  fail:
    msg: "PVC {{ kite_release_name }}-data is not bound. Status: {{ pvc_status.resources[0].status.phase if pvc_status.resources | length > 0 else 'Not found' }}"
  when: pvc_status.resources | length == 0 or (pvc_status.resources[0].status.phase is defined and pvc_status.resources[0].status.phase != "Bound")
  become: true
  run_once: true
  delegate_to: "{{ groups['k3s-nodes'][0] }}"

- name: Get Kite pods
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Pod
    namespace: "{{ kite_namespace }}"
    label_selectors:
      - "app.kubernetes.io/instance={{ kite_release_name }}"
    kubeconfig: "{{ kubeconfig_path }}"
  register: kite_pods_info
  become: true
  run_once: true
  delegate_to: "{{ groups['k3s-nodes'][0] }}"

- name: Verify PVC mount in each Kite pod
  assert:
    that:
      - item.spec.volumes is defined
      - item.spec.volumes | selectattr('persistentVolumeClaim', 'defined') | map(attribute='persistentVolumeClaim.claimName') | select('equalto', kite_release_name ~ '-data') | list | length > 0
    fail_msg: "PVC {{ kite_release_name }}-data not mounted in pod {{ item.metadata.name }}. Volumes: {{ item.spec.volumes | default([]) }}"
    success_msg: "PVC {{ kite_release_name }}-data is mounted in pod {{ item.metadata.name }}"
  loop: "{{ kite_pods_info.resources }}"
  loop_control:
    label: "{{ item.metadata.name }}"
  become: true
  run_once: true
  delegate_to: "{{ groups['k3s-nodes'][0] }}"

- name: Render Kite Ingress manifest
  template:
    src: kite-ingress.yaml.j2
    dest: /tmp/kite-ingress.yaml
    mode: '0644'
  become: true
  run_once: true
  delegate_to: "{{ groups['k3s-nodes'][0] }}"

- name: Apply Kite Ingress
  kubernetes.core.k8s:
    src: /tmp/kite-ingress.yaml
    kubeconfig: "{{ kubeconfig_path }}"
    state: present
  become: true
  run_once: true
  delegate_to: "{{ groups['k3s-nodes'][0] }}"