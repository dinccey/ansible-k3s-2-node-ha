---
- name: Add Bitnami Helm repo
  kubernetes.core.helm_repository:
    name: bitnami
    repo_url: "{{ bitnami_helm_repo }}"
  run_once: true
  delegate_to: "{{ groups['k3s-nodes'][0] }}"

- name: Add Kite Helm repo
  kubernetes.core.helm_repository:
    name: kite
    repo_url: "{{ kite_helm_repo }}"
  run_once: true
  delegate_to: "{{ groups['k3s-nodes'][0] }}"

- name: Render postgres values file
  template:
    src: postgres-values.yaml.j2
    dest: /tmp/postgres-values.yaml
    mode: '0644'
  become: true
  run_once: true
  delegate_to: "{{ groups['k3s-nodes'][0] }}"

- name: Install or upgrade PostgreSQL for Kite
  kubernetes.core.helm:
    name: "{{ postgres_ha_release }}"
    chart_ref: "{{ postgres_chart }}"
    release_namespace: "{{ postgres_namespace }}"
    create_namespace: true
    values_files:
      - /tmp/postgres-values.yaml
    wait: true
    timeout: 300s
    atomic: true
    kubeconfig: "{{ kubeconfig_path }}"
  become: true
  when: psql_master | default(false)
  run_once: true
  delegate_to: "{{ groups['k3s-nodes'][0] }}"

- name: Wait for postgres primary statefulset rollout
  command: kubectl -n {{ postgres_namespace }} rollout status statefulset/{{ postgres_ha_release }}-postgresql --timeout=300s
  register: postgres_rollout
  retries: 3
  delay: 10
  until: postgres_rollout.rc == 0
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"
  become: true
  run_once: true
  delegate_to: "{{ groups['k3s-nodes'][0] }}"

- name: Extract Kite DB password from secret
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Secret
    name: "{{ postgres_ha_release }}-postgresql"
    namespace: "{{ postgres_namespace }}"
    kubeconfig: "{{ kubeconfig_path }}"
  register: postgres_secret
  become: true
  run_once: true
  delegate_to: "{{ groups['k3s-nodes'][0] }}"

- name: Set kite_db_password fact from secret
  set_fact:
    kite_db_password: "{{ postgres_secret.resources[0].data.password | b64decode }}"

- name: Set DSN fact for Kite
  set_fact:
    kite_db_dsn: "postgres://{{ postgres_username }}:{{ kite_db_password }}@{{ postgres_ha_release }}-postgresql.{{ postgres_namespace }}.svc.cluster.local:5432/{{ postgres_database }}"

- name: Render kite values file
  template:
    src: kite-values.yaml.j2
    dest: /tmp/kite-values.yaml
    mode: '0644'
  become: true
  run_once: true
  delegate_to: "{{ groups['k3s-nodes'][0] }}"

- name: Ensure Kite namespace exists
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: "{{ kite_namespace }}"
    kubeconfig: "{{ kubeconfig_path }}"
  become: true
  run_once: true
  delegate_to: "{{ groups['k3s-nodes'][0] }}"

- name: Ensure Kite secret exists with DB config
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: "{{ kite_release_name }}-secret"
        namespace: "{{ kite_namespace }}"
        labels:
          app.kubernetes.io/managed-by: Helm
        annotations:
          meta.helm.sh/release-name: "{{ kite_release_name }}"
          meta.helm.sh/release-namespace: "{{ kite_namespace }}"
      type: Opaque
      data:
        DB_TYPE: "{{ 'postgres' | b64encode }}"
        DB_DSN: "{{ kite_db_dsn | b64encode }}"
    kubeconfig: "{{ kubeconfig_path }}"
  become: true
  run_once: true
  delegate_to: "{{ groups['k3s-nodes'][0] }}"

- name: Install or upgrade Kite via Helm
  kubernetes.core.helm:
    name: "{{ kite_release_name }}"
    chart_ref: "{{ kite_chart }}"
    release_namespace: "{{ kite_namespace }}"
    values_files:
      - /tmp/kite-values.yaml
    wait: true
    timeout: 900s
    atomic: true
    kubeconfig: "{{ kubeconfig_path }}"
  become: true
  run_once: true
  delegate_to: "{{ groups['k3s-nodes'][0] }}"

- name: Render Kite Ingress manifest
  template:
    src: kite-ingress.yaml.j2
    dest: /tmp/kite-ingress.yaml
    mode: '0644'
  become: true
  run_once: true
  delegate_to: "{{ groups['k3s-nodes'][0] }}"

- name: Apply Kite Ingress
  kubernetes.core.k8s:
    src: /tmp/kite-ingress.yaml
    kubeconfig: "{{ kubeconfig_path }}"
    state: present
  become: true
  run_once: true
  delegate_to: "{{ groups['k3s-nodes'][0] }}"

- name: Debug- check deployed DB_TYPE in Kite deployment
  command: kubectl -n {{ kite_namespace }} get deploy {{ kite_release_name }} -o jsonpath="{.spec.template.spec.containers[0].env[?(@.name=='DB_TYPE')].value}"
  register: kite_deployed_db_type
  failed_when: false
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"
  become: true
  run_once: true
  delegate_to: "{{ groups['k3s-nodes'][0] }}"

- name: If deployment still uses sqlite, dump kite-secret and fail with guidance
  when: kite_deployed_db_type.stdout == 'sqlite'
  block:
    - name: Get kite secret DB_TYPE
      command: kubectl -n {{ kite_namespace }} get secret {{ kite_release_name }}-secret -o jsonpath="{.data.DB_TYPE}" | base64 -d
      register: kite_secret_db_type
      failed_when: false
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"
      become: true
      run_once: true
      delegate_to: "{{ groups['k3s-nodes'][0] }}"

    - name: Get kite secret DB_DSN
      command: kubectl -n {{ kite_namespace }} get secret {{ kite_release_name }}-secret -o jsonpath="{.data.DB_DSN}" | base64 -d
      register: kite_secret_db_dsn
      failed_when: false
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"
      become: true
      run_once: true
      delegate_to: "{{ groups['k3s-nodes'][0] }}"

    - name: Fail and show diagnostics
      fail:
        msg: |
          Kite deployment still shows DB_TYPE={{ kite_deployed_db_type.stdout | default('<none>') }}.
          kite-secret contains DB_TYPE={{ kite_secret_db_type.stdout | default('<none>') }} and DB_DSN={{ kite_secret_db_dsn.stdout | default('<none>') }}.
          Possible causes:
            - Chart sets DB env vars from values that we didn't override. Run `helm show values {{ kite_chart }}` and check the DB keys.
            - Chart templates hardcode sqlite in the Deployment; you'll need to set the chart's DB config keys explicitly.
          I can (A) run `helm show values` and try to auto-detect the correct key, or (B) convert secret/values handling to use the `k8s` module for stronger guarantees.