apiVersion: batch/v1
kind: CronJob
metadata:
  name: pod-finalizer-cleaner
  namespace: kube-system
spec:
  schedule: "*/1 * * * *"
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: pod-finalizer-cleaner
          containers:
          - name: cleaner
            image: bitnami/kubectl:latest
            command:
            - /bin/sh
            - -c
            - |
              # Find pods stuck terminating (with or without finalizers)
              kubectl get pods --all-namespaces -o json \
              | jq -r '
                .items[]
                | select(.metadata.deletionTimestamp != null)
                | [.metadata.namespace, .metadata.name] | @tsv
              ' \
              | while read ns name; do
                  echo "Force deleting pod $ns/$name"
                  # Strip finalizers if present
                  kubectl patch pod "$name" -n "$ns" -p '{"metadata":{"finalizers":[]}}' --type=merge || true
                  # Force delete the pod object
                  kubectl delete pod "$name" -n "$ns" --grace-period=0 --force || true
                done
          restartPolicy: OnFailure
