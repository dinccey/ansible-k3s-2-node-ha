- name: Set SELinux to disabled state
  selinux:
    state: disabled
  when: ansible_distribution == 'CentOS' or ansible_distribution == 'Red Hat Enterprise Linux'

- name: Enable IPv4 forwarding
  sysctl:
    name: net.ipv4.ip_forward
    value: "1"
    state: present
    reload: yes

- name: Enable IPv6 forwarding
  sysctl:
    name: net.ipv6.conf.all.forwarding
    value: "1"
    state: present
    reload: yes

- name: Download k3s binary x64
  get_url:
      url: https://github.com/rancher/k3s/releases/download/{{ k3s_version }}/k3s
      dest: /usr/local/bin/k3s
      owner: root
      group: root
      mode: 755
  when: ( ansible_facts.architecture == "x86_64" ) 

- name: Download k3s binary arm64(aarch64)
  get_url:
      url: https://github.com/rancher/k3s/releases/download/{{ k3s_version }}/k3s-arm64
      dest: /usr/local/bin/k3s
      owner: root
      group: root
      mode: 755
      timeout: 20
  when: ( ansible_facts.architecture == "aarch64" )

- name: Copy K3s service file
  register: k3s_service
  template:
    src: "k3s.service.j2"
    dest: "{{ k3s_systemd_dir }}/k3s.service"
    owner: root
    group: root
    mode: 0755

# restart postgresql before checking k3s service so it doesn't hang
- name: Restart PostgreSQL service
  systemd:
    name: postgresql
    state: restarted  


# In roles/k3s/tasks/main.yml or site.yml
- name: Restart K3s on all masters one by one
  include_tasks: restart-k3s.yml
  loop: "{{ groups['masters'] }}"
  loop_control:
    loop_var: target_node
  when: inventory_hostname == target_node

- name: Configure K3s fast-failover config file
  template:
    src: k3s-config.yaml.j2
    dest: /etc/rancher/k3s/config.yaml
    owner: root
    group: root
    mode: '0644'
  become: true

- name: Configure K3s fast-failover config file
  template:
    src: k3s-config.yaml.j2
    dest: /etc/rancher/k3s/config.yaml
    owner: root
    group: root
    mode: '0644'
  become: true
  when: "'masters' in groups and ansible_hostname in groups['masters']"

- name: Enable and start K3s service (with config applied)
  systemd:
    name: k3s
    daemon_reload: yes
    state: restarted
    enabled: yes
  become: true
  when: "'masters' in groups and ansible_hostname in groups['masters']"

- name: Create directory .kube
  file:
    path: ~{{ ansible_user }}/.kube
    state: directory
    owner: "{{ ansible_user }}"

- name: Copy config file to user home directory
  copy:
    src: /etc/rancher/k3s/k3s.yaml
    dest: ~{{ ansible_user }}/.kube/config
    remote_src: yes
    owner: "{{ ansible_user }}"

- name: Ensure user's KUBECONFIG points to their copied kubeconfig
  lineinfile:
    path: ~{{ ansible_user }}/.bashrc
    regexp: '^export KUBECONFIG='
    line: 'export KUBECONFIG=~/.kube/config'
    create: yes
    owner: "{{ ansible_user }}"
    mode: '0644'
  become: true
  become_user: root

- name: Rewrite kubeconfig default context
  command: k3s kubectl config set-cluster default
    --server=https://{{ keepalived_virtual_ip }}:6443
    --kubeconfig ~{{ ansible_user }}/.kube/config

- name: Remove existing kubectl binary (if any)
  file:
    path: /usr/local/bin/kubectl
    state: absent
  become: true

- name: Create kubectl symlink to k3s
  file:
    src: /usr/local/bin/k3s
    dest: /usr/local/bin/kubectl
    state: link
    force: yes        # <--- important!
  become: true

- name: Create crictl symlink
  file:
    src: /usr/local/bin/k3s
    dest: /usr/local/bin/crictl
    state: link

- name: Render pod-finalizer-cleaner CronJob manifest
  template:
    src: pod-finalizer-cleaner-cronjob.yaml.j2
    dest: /tmp/pod-finalizer-cleaner-cronjob.yaml
    owner: root
    group: root
    mode: '0644'
  become: true
  run_once: true
  delegate_to: "{{ groups['k3s-nodes'][0] }}"

- name: Apply pod-finalizer-cleaner CronJob
  command: /usr/local/bin/k3s kubectl apply -f /tmp/pod-finalizer-cleaner-cronjob.yaml
  register: cronjob_apply
  retries: 5
  delay: 6
  until: cronjob_apply.rc == 0
  become: true
  run_once: true
  delegate_to: "{{ groups['k3s-nodes'][0] }}"


- name: Render pod-finalizer-cleaner RBAC manifest
  template:
    src: pod-finalizer-cleaner-rbac.yaml.j2
    dest: /tmp/pod-finalizer-cleaner-rbac.yaml
    owner: root
    group: root
    mode: '0644'
  become: true
  run_once: true
  delegate_to: "{{ groups['k3s-nodes'][0] }}"

- name: Apply pod-finalizer-cleaner RBAC
  command: /usr/local/bin/k3s kubectl apply -f /tmp/pod-finalizer-cleaner-rbac.yaml
  register: cronjob_rbac_apply
  retries: 5
  delay: 6
  until: cronjob_rbac_apply.rc == 0
  become: true
  run_once: true
  delegate_to: "{{ groups['k3s-nodes'][0] }}"


- name: Deploy Traefik DaemonSet manifest (optional)
  when: install_traefik_daemonset | default(false)
  block:
    - name: Template Traefik manifest into place
      template:
        src: traefik-daemonset.yaml.j2
        dest: /tmp/traefik-daemonset.yaml
        owner: root
        group: root
        mode: '0644'

    - name: Apply Traefik manifest
      command: /usr/local/bin/k3s kubectl apply -f /tmp/traefik-daemonset.yaml
      register: traefik_apply
      retries: 3
      delay: 5
      until: traefik_apply.rc == 0
