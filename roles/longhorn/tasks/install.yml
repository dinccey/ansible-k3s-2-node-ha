---
- name: Install open-iscsi package (Debian/Ubuntu)
  apt:
    name: open-iscsi
    state: present
    update_cache: true
  when: ansible_os_family == 'Debian'

- name: Install nfs package (Debian/Ubuntu)
  apt:
    name: nfs-kernel-server
    state: present
    update_cache: true
  when: ansible_os_family == 'Debian'

- name: Load iscsi_tcp kernel module
  copy:
    dest: /etc/modules-load.d/iscsi_tcp.conf
    content: "iscsi_tcp\n"
    owner: root
    group: root
    mode: '0644'
  become: true

- name: Load iscsi_tcp kernel module now (if not already loaded)
  shell: lsmod | grep iscsi_tcp || modprobe iscsi_tcp
  register: modprobe_out
  failed_when: modprobe_out.rc != 0
  become: true

- name: Add Longhorn Helm repo
  shell: |
    helm repo add longhorn {{ longhorn_chart_repo }}
  args:
    creates: /root/.cache/helm/repository/longhorn-index.yaml
  register: add_repo
  failed_when: add_repo.rc not in [0,1]
  changed_when: add_repo.rc == 0
  when: psql_master | default(false)
  become: true
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml

- name: Update Helm repos
  shell: helm repo update
  register: repo_update
  failed_when: repo_update.rc != 0
  when: psql_master | default(false)
  become: true
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml

- name: Ensure longhorn namespace exists
  shell: |
    kubectl get namespace {{ longhorn_namespace }} || kubectl create namespace {{ longhorn_namespace }}
  register: ns_create
  changed_when: ns_create.rc == 0 and ns_create.stdout != ''
  failed_when: ns_create.rc != 0 and ns_create.rc != 1
  when: psql_master | default(false)
  become: true
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml

- name: Install or upgrade Longhorn via Helm
  shell: |
    helm upgrade --install {{ longhorn_release_name }} longhorn/longhorn \
      --namespace {{ longhorn_namespace }} \
      --version {{ longhorn_version }} \
      --create-namespace \
      --set-string defaultSettings.defaultReplicaCount={{ default_replica_count }} \
      --set-string defaultSettings.guaranteedInstanceManagerCPU={{ guaranteed_instance_manager_cpu }} \
      --set ingress.enabled=true \
      --set ingress.host={{ longhorn_host }} \
      --set ingress.ingressClassName=traefik \
      --set ingress.tls=false \
      --set ingress.annotations."traefik.ingress.kubernetes.io/router.entrypoints"="web" \
      --set ingress.annotations."traefik.ingress.kubernetes.io/router.middlewares"="traefik-default-redirect@kubernetescrd"
  register: longhorn_install
  changed_when: longhorn_install.rc == 0 and 'unchanged' not in longhorn_install.stdout | default('')
  failed_when: longhorn_install.rc != 0
  when: psql_master | default(false)
  become: true
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml

- name: Copy Longhorn StorageClass manifest to host
  when: psql_master | default(false)
  copy:
    src: files/longhorn-storageclass.yaml
    dest: /tmp/longhorn-storageclass.yaml
    owner: root
    group: root
    mode: '0644'
  become: true
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml

- name: Apply Longhorn StorageClass
  when: psql_master | default(false)
  command: /usr/local/bin/k3s kubectl apply -f /tmp/longhorn-storageclass.yaml
  register: longhorn_sc_apply
  retries: 3
  delay: 9
  until: longhorn_sc_apply.rc == 0
  become: true
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml

- name: Wait for Longhorn pods to be created and show status
  shell: kubectl -n {{ longhorn_namespace }} get pods
  register: longhorn_pods
  failed_when: longhorn_pods.rc != 0
  when: psql_master | default(false)
  become: true
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml

- name: Patch Longhorn settings for fast reschedule and rebuild
  shell: |
    set -e
    kubectl -n {{ longhorn_namespace }} patch setting default-replica-count --type=merge -p '{"value":"{{ default_replica_count }}"}' || true
    kubectl -n {{ longhorn_namespace }} patch setting offline-replica-rebuilding --type=merge -p '{"value":"{{ longhorn_replica_rebuild_offline | ternary("true","false") }}"}' || true
    kubectl -n {{ longhorn_namespace }} patch setting default-data-locality --type=merge -p '{"value":"{{ longhorn_data_locality }}"}' || true
    kubectl -n {{ longhorn_namespace }} patch setting allow-volume-creation-with-degraded-availability --type=merge -p '{"value":"{{ longhorn_allow_degraded | ternary("true","false") }}"}' || true
    kubectl -n {{ longhorn_namespace }} patch setting pod-deletion-policy-when-node-is-down --type=merge -p '{"value":"{{ longhorn_pod_deletion_policy }}"}' || true
  when: psql_master | default(false)
  become: true
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml


# verify:
# kubectl get settings.longhorn.io -n longhorn-system -o yaml | grep -E 'default-replica-count|offline-replica-rebuilding|default-data-locality|allow-volume-creation-with-degraded-availability|pod-deletion-policy-when-node-is-down'
