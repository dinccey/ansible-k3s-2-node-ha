---
# roles/helm/tasks/install.yml

- name: Ensure apt dependencies for Helm are installed (Debian/Ubuntu)
  apt:
    name:
      - curl
      - gpg
      - apt-transport-https
    state: present
    update_cache: true
  become: true
  when: ansible_os_family == 'Debian'

- name: Quick pre-check - is helm already installed?
  command: /usr/local/bin/helm version --short
  register: helm_check
  failed_when: false
  changed_when: false

- name: Install Helm (official script) if missing
  shell: |
    curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
  args:
    creates: /usr/local/bin/helm
  become: true
  when: helm_check.rc != 0

- name: Quick pre-check - is kubectl already installed?
  command: kubectl version --client --short
  register: kubectl_check
  failed_when: false
  changed_when: false

- name: Create /usr/local/bin/kubectl wrapper that delegates to k3s (if missing)
  copy:
    dest: /usr/local/bin/kubectl
    content: |
      #!/bin/sh
      # Wrapper to delegate kubectl calls to k3s kubectl when standalone kubectl is missing
      exec /usr/local/bin/k3s kubectl "$@"
    mode: '0755'
  become: true
  when: kubectl_check.rc != 0

- name: Fetch Helm GPG key and dearmor it
  shell: |
    set -o pipefail
    curl -fsSL {{ helm_repo_key_url }} | gpg --dearmor > {{ helm_gpg_path }}
  args:
    creates: "{{ helm_gpg_path }}"
  become: true

- name: Add Helm apt repository list file
  copy:
    dest: "{{ helm_repo_list_file }}"
    content: |
      deb [signed-by={{ helm_gpg_path }}] https://packages.buildkite.com/helm-linux/helm-debian/any/ any main
    owner: root
    group: root
    mode: '0644'
  become: true

- name: Install Kubernetes Python client
  apt:
    name: python3-kubernetes
    state: present
    update_cache: yes
  become: true

- name: Wait for /etc/rancher/k3s/k3s.yaml to exist (kubeconfig)
  wait_for:
    path: /etc/rancher/k3s/k3s.yaml
    state: present
    timeout: 300
  become: true

- name: Validate kubeconfig file using kubectl
  shell: |
    /usr/local/bin/k3s kubectl --kubeconfig /etc/rancher/k3s/k3s.yaml cluster-info
  register: kubeconfig_validation
  retries: 5
  delay: 10
  until: kubeconfig_validation.rc == 0
  become: true

- name: Debug API server connectivity
  shell: |
    curl -k https://{{ keepalived_virtual_ip }}:6443/healthz
  register: api_health_check
  retries: 5
  delay: 10
  until: api_health_check.rc == 0
  become: true

- name: Debug kubeconfig file existence and content
  debug:
    msg: "Kubeconfig file content: {{ lookup('file', '/etc/rancher/k3s/k3s.yaml') }}"
  when: ansible_facts['os_family'] == 'Linux'

- name: Ensure kubeconfig file has correct permissions
  file:
    path: /etc/rancher/k3s/k3s.yaml
    owner: root
    group: root
    mode: '0644'
  become: true

- name: Debug kubeconfig file permissions on all nodes
  stat:
    path: /etc/rancher/k3s/k3s.yaml
  register: kubeconfig_stat
  become: true

- name: Debug kubeconfig file details
  debug:
    msg:
      - "Kubeconfig file exists: {{ kubeconfig_stat.stat.exists }}"
      - "Kubeconfig file owner: {{ kubeconfig_stat.stat.pw_name }}"
      - "Kubeconfig file group: {{ kubeconfig_stat.stat.gr_name }}"
      - "Kubeconfig file mode: {{ kubeconfig_stat.stat.mode | string | regex_replace('^0o', '0') }}"

- name: Wait until K3s API is responsive via k3s kubectl
  shell: |
    /usr/local/bin/k3s kubectl --kubeconfig /etc/rancher/k3s/k3s.yaml get nodes
  register: k3s_api_check
  retries: 60
  delay: 5
  until: k3s_api_check.rc == 0
  failed_when: false
  become: true

- name: Wait for K3s API server to be ready (Node Ready)
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Node
    wait: yes
    wait_condition:
      type: Ready
      status: "True"
    wait_timeout: 300
    kubeconfig: /etc/rancher/k3s/k3s.yaml
  register: k8s_info_debug
  become: true

- name: Debug Kubernetes Core Module output
  debug:
    var: k8s_info_debug

- name: Ensure KUBECONFIG export is present in user's .bashrc
  lineinfile:
    path: "/home/{{ kube_user }}/.bashrc"
    line: 'export KUBECONFIG=~/.kube/config'
    create: true
    state: present
  become: true
  become_user: "{{ kube_user }}"

- name: Create cert-manager namespace (idempotent)
  shell: |
    kubectl create namespace cert-manager --dry-run=client -o yaml | kubectl apply -f -
  register: cert_ns
  changed_when: cert_ns.rc == 0 and cert_ns.stdout != ''
  failed_when: cert_ns.rc != 0 and cert_ns.rc != 1
  become: true

- name: Install cert-manager v1.15.3
  shell: |
    kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.15.3/cert-manager.yaml
  register: cert_apply
  changed_when: cert_apply.rc == 0
  failed_when: cert_apply.rc not in [0, 1]
  become: true

- name: Wait for cert-manager namespace to exist
  kubernetes.core.k8s:
    kubeconfig: /etc/rancher/k3s/k3s.yaml
    state: present
    kind: Namespace
    name: cert-manager
  register: ns_check
  until: ns_check is succeeded
  retries: 30
  delay: 10
    
  become: true

- name: Wait for cert-manager deployment to be ready
  kubernetes.core.k8s:
    kubeconfig: /etc/rancher/k3s/k3s.yaml
    state: present
    kind: Deployment
    name: cert-manager
    namespace: cert-manager
    wait: true
    wait_condition:
      type: Available
      status: "True"
    wait_timeout: 300
    
  become: true