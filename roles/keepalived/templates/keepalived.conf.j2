global_defs {
  router_id {{ inventory_hostname }}
}

vrrp_script check_port_available {
    script "/etc/keepalived/check_port_available.sh"
    interval 5
    timeout 5
    fall 3
    rise 2
}

vrrp_script check_primary_running {
    script "/etc/keepalived/check_primary_running.sh {{ inventory_hostname }}"
    interval 5
    timeout 10
    fall 3
    rise 2
    user postgres
}

vrrp_instance postgres-cluster {
  state BACKUP
  priority 50
  # debug 2
  virtual_router_id 90
  # nopreempt

  interface {{ keepalived_vrrp_iface }}
  unicast_src_ip {{ private_ip }}
  unicast_peer {
    {{ unicast_peer }}
  }

  virtual_ipaddress {
    {{ keepalived_virtual_ip }}
  }

  track_script {
    check_primary_running weight 50
    check_port_available
  }

  notify_master "/etc/keepalived/notify.sh MASTER"
  notify_backup "/etc/keepalived/notify.sh BACKUP"
  notify_fault "/etc/keepalived/notify.sh FAULT"

  # GARP for fast ARP cache updates
  garp_master_delay 1      # Delay before first GARP set after becoming MASTER (default 5s; lower for speed)
  garp_master_repeat 5     # Number of GARPs in initial burst (default 5; sends 5x quickly)
  garp_master_refresh 5    # Periodic GARP interval in seconds while MASTER (0=disabled; 5s for ~every few seconds)
  garp_master_refresh_repeat 3  # GARPs per refresh cycle (default 1; 3x for reliability)
  vrrp_garp_interval 0.01  # Delay between individual GARPs in ms (default 0; 10ms prevents flooding)
}
